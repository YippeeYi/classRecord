<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>ç­çº§çºªäº‹æœ¬å®‰å…¨ç‰ˆ</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <h1>ç­çº§çºªäº‹æœ¬å®‰å…¨ç‰ˆ</h1>

    <form id="recordForm">
        <label>æ—¥æœŸ: <input type="date" id="date" required></label>
        <label>æ—¶é—´ï¼ˆå¯é€‰ï¼‰: <input type="time" id="time"></label>
        <label>ä½œè€…: <input type="text" id="author" required></label>
        <label>å†…å®¹: <textarea id="content" required></textarea></label>
        <label>å›¾ç‰‡: <input type="file" id="image" accept="image/*" required></label>
        <button type="submit">æäº¤è®°å½•</button>
    </form>

    <h2>å·²æœ‰è®°å½•</h2>
    <div id="record-list"></div>

    <script>
        const REPO_OWNER = "yippeeyi"; // ä¿®æ”¹ä¸ºä½ çš„ç”¨æˆ·å
        const REPO_NAME = "classRecord";     // ä¿®æ”¹ä¸ºä½ çš„ä»“åº“å
        const DATA_DIR = "data";               // ä»“åº“ data/ æ–‡ä»¶å¤¹

        let existingRecords = [];

        // æ¸²æŸ“è®°å½•
        function renderRecords(records) {
            const container = document.getElementById("record-list");
            container.innerHTML = "";
            records.sort((a, b) => {
                if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
                const hasTimeA = !!a.time, hasTimeB = !!b.time;
                if (hasTimeA && hasTimeB) return new Date(b.date + " " + b.time) - new Date(a.date + " " + a.time);
                if (hasTimeA && !hasTimeB) return -1;
                if (!hasTimeA && hasTimeB) return 1;
                const orderA = a.order || 0, orderB = b.order || 0;
                if (orderA !== orderB) return orderA - orderB;
                return b.id - a.id;
            });
            records.forEach(r => {
                const timeText = r.time ? r.time : (r.order ? `å½“æ—¥ç¬¬ ${r.order} æ¡` : "æ—¶é—´ä¸è¯¦");
                const div = document.createElement("div");
                div.className = "record";
                div.innerHTML = `
      <div class="meta">ğŸ“… ${r.date} ${timeText} | âœ ${r.author}</div>
      <div class="content">${r.content}</div>
      <img src="${r.image}" alt="è®°å½•å›¾ç‰‡">
    `;
                container.appendChild(div);
            });
        }

        // -------------------- åŠ è½½å†å²è®°å½• --------------------
        async function loadGitHubRecords() {
            try {
                const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_DIR}`;
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error("æ— æ³•è·å–ä»“åº“ data/ æ–‡ä»¶åˆ—è¡¨");
                const files = await res.json();
                const jsonFiles = files.filter(f => f.name.endsWith(".json"));
                const records = [];
                for (const file of jsonFiles) {
                    const r = await fetch(file.download_url);
                    const data = await r.json();
                    records.push(data);
                }
                existingRecords = records;
                renderRecords(existingRecords);
            } catch (err) {
                console.error(err);
                alert("åŠ è½½å†å²è®°å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚");
            }
        }

        // åˆæ¬¡åŠ è½½
        loadGitHubRecords();

        // -------------------- è¡¨å•æäº¤ --------------------
        document.getElementById("recordForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const date = document.getElementById("date").value;
            const time = document.getElementById("time").value;
            const author = document.getElementById("author").value.trim();
            const content = document.getElementById("content").value.trim();
            const imageInput = document.getElementById("image");

            if (!date || !author || !content || !imageInput.files.length) {
                alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯å¹¶ä¸Šä¼ å›¾ç‰‡ï¼");
                return;
            }

            const imageFile = imageInput.files[0];
            const todayRecords = existingRecords.filter(r => r.date === date);
            const order = todayRecords.length + 1;

            const ext = imageFile.name.substring(imageFile.name.lastIndexOf('.'));
            const imageName = `${date}-${String(order).padStart(2, '0')}${ext}`;

            const record = {
                id: Date.now(),
                date: date,
                time: time || "",
                order: order,
                author: author,
                content: content,
                image: `images/${imageName}`
            };

            try {
                const formData = new FormData();
                formData.append("jsonFile", new Blob([JSON.stringify(record, null, 2)], { type: "application/json" }), `${date}-${String(order).padStart(2, '0')}.json`);
                formData.append("imageFile", imageFile, imageName);

                // POST ä¸Šä¼ åˆ° /upload-endpointï¼ˆGitHub Actions æˆ–åç«¯ä¸­è½¬ï¼‰
                const res = await fetch("/upload-endpoint", { method: "POST", body: formData });
                if (!res.ok) throw new Error("ä¸Šä¼ å¤±è´¥");

                existingRecords.push(record);
                renderRecords(existingRecords);
                alert("è®°å½•æäº¤æˆåŠŸï¼ŒGitHub Actions ä¼šè‡ªåŠ¨å¤„ç† JSON å’Œå›¾ç‰‡ã€‚");
                document.getElementById("recordForm").reset();
            } catch (err) {
                console.error(err);
                alert("ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚");
            }
        });
    </script>

</body>

</html>