/************************************************************
 * ç­çº§çºªäº‹æœ¬ - script.js
 *
 * åŠŸèƒ½è¯´æ˜ï¼š
 * 1. ä» data/records.json è¯»å–æ‰€æœ‰è®°å½•
 * 2. å¯¹è®°å½•è¿›è¡Œâ€œç¨³å®šä¸”å¯è§£é‡Šâ€çš„æ’åº
 * 3. å°†æ’åºåçš„è®°å½•æ¸²æŸ“åˆ°ç½‘é¡µä¸­
 *
 * è®¾è®¡åŸåˆ™ï¼š
 * - æ•°æ®å¯èƒ½ä¸å®Œç¾ï¼Œä½†é¡µé¢ä¸èƒ½ä¹±
 * - æ’åºè§„åˆ™æ¸…æ™°ã€é•¿æœŸå¯ç»´æŠ¤
 * - ä¸ºæœªæ¥ä¿®æ”¹ä¿ç•™ç©ºé—´
 ************************************************************/


/************************************************************
 * ä¸€ã€è¯»å–è®°å½•æ•°æ®
 *
 * records_index.json æ‰€æœ‰è®°å½•æ–‡ä»¶å
 * å•ä¸ªè®°å½•ç¤ºä¾‹ï¼š
 * {
 *   "id": 12,
 *   "date": "2024-10-05",
 *   "time": "",          // å¯èƒ½ä¸ºç©º
 *   "order": 2,          // ä»…åœ¨ time ä¸ºç©ºæ—¶ä½¿ç”¨
 *   "author": "è®°å½•å‘˜A",
 *   "content": "...",
 *   "image": "images/xxx.jpg"
 * }
 ************************************************************/

// é¡µé¢å®¹å™¨
const container = document.getElementById("record-list");

fetch("data/records_index.json")
    .then(res => res.json())
    .then(fileList => {
        // fileList æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«æ‰€æœ‰è®°å½• JSON æ–‡ä»¶å
        const promises = fileList.map(filename => fetch(`data/${filename}`).then(res => res.json()));
        return Promise.all(promises); // ç­‰å¾…æ‰€æœ‰ JSON åŠ è½½å®Œæˆ
    })
    .then(records => {

        /********************************************************
         * äºŒã€æ’åºè§„åˆ™ï¼ˆéå¸¸é‡è¦ï¼‰
         *
         * æ’åºä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
         * 1. date   ï¼šæ—¥æœŸæ™šçš„åœ¨å‰
         * 2. time   ï¼š
         *    - æœ‰å…·ä½“æ—¶é—´çš„è®°å½•ï¼ŒæŒ‰çœŸå®æ—¶é—´æ’åº
         *    - æœ‰æ—¶é—´çš„è®°å½•ï¼Œä¸€å®šæ’åœ¨â€œæ— æ—¶é—´â€çš„å‰é¢
         * 3. order  ï¼š
         *    - åŒä¸€å¤©
         *    - éƒ½æ²¡æœ‰ time
         *    - ä½¿ç”¨äººå·¥æŒ‡å®šçš„å…ˆåé¡ºåº
         * 4. id     ï¼šå…œåº•æ’åºï¼Œç¡®ä¿æ’åºç¨³å®š
         *
         * è¯´æ˜ï¼š
         * - åœ¨â€œæ•°æ®å®Œå…¨è§„èŒƒâ€çš„æƒ…å†µä¸‹ï¼Œç¬¬ 4 æ­¥ç†è®ºä¸Šä¸ä¼šè§¦å‘
         * - ä½†ä¸ºäº†é˜²æ­¢æœªæ¥æ•°æ®å‡ºé”™ï¼Œå¿…é¡»ä¿ç•™
         ********************************************************/
        records.sort((a, b) => {

            /* ---------- 1. æŒ‰æ—¥æœŸæ’åº ---------- */
            if (a.date !== b.date) {
                // æ—¥æœŸæ–°çš„æ’åœ¨å‰é¢
                return new Date(b.date) - new Date(a.date);
            }

            /* ---------- 2. åŒä¸€å¤©ï¼Œå¤„ç† time ---------- */
            const hasTimeA = Boolean(a.time);
            const hasTimeB = Boolean(b.time);

            // ä¸¤æ¡è®°å½•éƒ½æœ‰ timeï¼Œç›´æ¥æŒ‰çœŸå®æ—¶é—´æ¯”è¾ƒ
            if (hasTimeA && hasTimeB) {
                return (
                    new Date(b.date + " " + b.time) -
                    new Date(a.date + " " + a.time)
                );
            }

            // åªæœ‰ä¸€æ¡æœ‰ timeï¼šæœ‰æ—¶é—´çš„æ’åœ¨å‰é¢
            if (hasTimeA && !hasTimeB) return -1;
            if (!hasTimeA && hasTimeB) return 1;

            /* ---------- 3. åŒä¸€å¤©ï¼Œä¸”éƒ½æ²¡æœ‰ timeï¼Œç”¨ order ---------- */
            const orderA = typeof a.order === "number" ? a.order : 0;
            const orderB = typeof b.order === "number" ? b.order : 0;

            if (orderA !== orderB) {
                // order å°çš„è¡¨ç¤ºâ€œæ›´æ—©å‘ç”Ÿâ€
                return orderA - orderB;
            }

            /* ---------- 4. æœ€ç»ˆå…œåº•ï¼šæŒ‰ id ---------- */
            // ç†è®ºä¸Šä¸åº”èµ°åˆ°è¿™é‡Œ
            // ä½œç”¨ï¼šé˜²æ­¢å®Œå…¨ç›¸ç­‰å¯¼è‡´æ’åºä¸ç¨³å®š
            return b.id - a.id;
        });


        /********************************************************
         * ä¸‰ã€æ¸²æŸ“åˆ°é¡µé¢
         ********************************************************/

        records.forEach(record => {

            /* ---------- å¤„ç†æ˜¾ç¤ºç”¨çš„æ—¶é—´æ–‡æœ¬ ---------- */
            let timeText = "ï¼ˆæ—¶é—´ä¸è¯¦ï¼‰";

            if (record.time) {
                // æœ‰æ˜ç¡®æ—¶é—´
                timeText = record.time;
            } else if (record.order) {
                // æ²¡æœ‰æ—¶é—´ï¼Œä½†æœ‰äººå·¥é¡ºåº
                timeText = `ï¼ˆå½“æ—¥ç¬¬ ${record.order} æ¡ï¼‰`;
            }

            /* ---------- åˆ›å»ºè®°å½•å¡ç‰‡ ---------- */
            const div = document.createElement("div");
            div.className = "record";

            div.innerHTML = `
        <div class="meta">
          ğŸ“… ${record.date} ${timeText} ï½œ âœ ${record.author}
        </div>

        <div class="content">
          ${record.content}
        </div>

        <img src="${record.image}" alt="è®°å½•åŸå§‹ç…§ç‰‡">
      `;

            container.appendChild(div);
        });
    })


    /********************************************************
     * å››ã€é”™è¯¯å¤„ç†ï¼ˆé˜²æ­¢é¡µé¢ç©ºç™½ï¼‰
     ********************************************************/
    .catch(error => {
        console.error("åŠ è½½è®°å½•å¤±è´¥ï¼š", error);
        container.innerHTML = `<p style="color:red;">è®°å½•åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ records.json æ˜¯å¦å­˜åœ¨æˆ–æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚</p>`;
    });
